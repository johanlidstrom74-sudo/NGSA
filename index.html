<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Rörgodstjocklek enligt NGSA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA / iPhone som app -->
  <meta name="theme-color" content="#5f46c6">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="NGSA Rörgodstjocklek">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1.5rem;
      background: linear-gradient(135deg, #f6f0ff, #e5d9ff);
      min-height: 100vh;
      box-sizing: border-box;
    }
    h1 {
      font-size: 1.7rem;
      margin-bottom: 0.3rem;
    }
    .card {
      background: #fff;
      max-width: 780px;
      margin-top: 1rem;
      padding: 1.5rem 1.6rem 1.2rem;
      border-radius: 16px;
      box-shadow: 0 6px 18px rgba(60, 34, 120, 0.18);
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
      gap: 0.75rem 1rem;
    }
    label {
      font-size: 0.9rem;
      font-weight: 600;
      display: block;
      margin-bottom: 0.25rem;
    }
    input, select {
      width: 100%;
      padding: 0.4rem 0.5rem;
      border-radius: 6px;
      border: 1px solid #c8c4e0;
      font-size: 0.9rem;
      box-sizing: border-box;
    }
    input[readonly] {
      background: #f5f3ff;
    }

    /* Ta bort små rullistor (spinners) på number-fält */
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type=number] {
      -moz-appearance: textfield;
    }

    .buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    button {
      padding: 0.6rem 1.4rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      background: #5f46c6;
      color: #fff;
    }
    button.secondary {
      background: #ffffff;
      color: #5f46c6;
      border: 1px solid #5f46c6;
    }
    button:hover {
      filter: brightness(0.95);
    }
    .result {
      margin-top: 1.2rem;
      padding-top: 0.9rem;
      border-top: 1px solid #e0e4f0;
      font-size: 1rem;
      line-height: 1.5;
    }
    .result strong {
      font-size: 1.05rem;
    }
    .result-main {
      font-size: 1.1rem;
      margin-bottom: 0.4rem;
    }
    .result-main span.label {
      font-weight: 700;
    }
    .result-main span.value {
      font-weight: 700;
    }
    .small {
      font-size: 0.8rem;
      color: #555;
    }
    .warning {
      margin-top: 0.4rem;
      padding: 0.4rem 0.6rem;
      border-radius: 6px;
      background: #ffe6e6;
      border: 1px solid #ff9b9b;
      color: #b30000;
      font-size: 0.9rem;
    }
    .ok {
      margin-top: 0.4rem;
      padding: 0.3rem 0.6rem;
      border-radius: 6px;
      background: #e5f7ea;
      border: 1px solid #91d0a4;
      color: #166534;
      font-size: 0.85rem;
    }
    footer {
      margin-top: 1rem;
      font-size: 0.8rem;
      color: #43336b;
      text-align: left;
    }

    /* PDF / utskrift – komprimerad layout */
    @media print {
      body {
        background: #ffffff;
        padding: 0.3rem;
      }
      h1 {
        font-size: 1.3rem;
        margin-bottom: 0.1rem;
      }
      .card {
        box-shadow: none;
        padding: 0.8rem 0.9rem 0.7rem;
        margin-top: 0.3rem;
        max-width: 100%;
      }
      .grid {
        gap: 0.4rem 0.5rem;
      }
      h2 {
        font-size: 0.95rem !important;
        margin-top: 0.4rem !important;
        margin-bottom: 0.2rem !important;
      }
      .result {
        font-size: 0.9rem;
        margin-top: 0.6rem;
        padding-top: 0.5rem;
      }
      .result-main {
        font-size: 1rem;
      }
      .small {
        font-size: 0.7rem;
      }
      .warning, .ok {
        font-size: 0.8rem;
        margin-top: 0.3rem;
        padding: 0.25rem 0.45rem;
      }
      footer {
        font-size: 0.7rem;
        margin-top: 0.4rem;
      }
      .buttons {
        display: none;
      }
    }
  </style>
</head>
<body>
  <h1>Rörgodstjocklek enligt NGSA</h1>
  <p class="small">
    <code>T<sub>min</sub> = (DP · D) / (20 · f₀ · R<sub>t0,5</sub> · z)</code><br/>
    <code>T<sub>nom</sub> = T<sub>min</sub> + a + c</code><br/>
    R<sub>t0,5</sub> tas ur materialtabeller (20–60&nbsp;°C resp. 20–100&nbsp;°C) med linjär interpolering.
  </p>

  <div class="card">
    <h2 style="font-size:1.05rem;margin-top:0">1. Förläggning och zon (tabell 4.16)</h2>
    <div class="grid" style="margin-bottom:0.5rem">
      <div>
        <label for="location">Ledningens förläggning</label>
        <select id="location" onchange="updateF0Field()">
          <option value="kompressor">I kompressorstation, mätstation samt mät- och reglerstation.</option>
          <option value="utanSkydd">Utan skyddsrör i område för allmän väg och i spårområde för järnväg.</option>
          <option value="rorbrygga">I rörbrygga.</option>
          <option value="tunnel">I tunnel.</option>
          <option value="linjeventil">I linjeventilstation och rensdonstation.</option>
          <option value="skyddsror">I skyddsrör i område för allmän väg och i spårområde för järnväg.</option>
          <option value="enskildVag">I område för enskild väg.</option>
          <option value="annan">Annan icke nämnd förläggning.</option>
        </select>
      </div>
      <div>
        <label for="zone">Zon</label>
        <select id="zone" onchange="updateF0Field()">
          <option value="A">Zon A</option>
          <option value="B">Zon B</option>
          <option value="C">Zon C</option>
          <option value="D">Zon D</option>
          <option value="T">Zon T</option>
        </select>
      </div>
      <div>
        <label for="f0">Beräkningsfaktor f₀</label>
        <input id="f0" type="number" step="0.01" readonly />
        <div class="small">Sätts automatiskt från tabell 4.16</div>
      </div>
    </div>

    <h2 style="font-size:1.05rem;margin-top:1rem">2. Material och temperatur</h2>
    <div class="grid">
      <div>
        <label for="material">Material</label>
        <select id="material">
          <option value="L245">L245 (L245NE/ME)</option>
          <option value="L290">L290 (L290NE/ME)</option>
          <option value="L360">L360 (L360NE/QE/ME)</option>
          <option value="L415">L415 (L415NE/QE/ME)</option>
          <option value="L450">L450 (L450QE/ME)</option>
          <option value="L485">L485 (L485QE/ME)</option>
          <option value="L555">L555 (L555QE/ME)</option>
          <option value="SA333G6">SA333 Gr.6</option>
        </select>
      </div>
      <div>
        <label for="temp">Beräkningstemperatur (°C)</label>
        <input id="temp" type="number" value="20" />
        <div class="small">Linjär interpolering mellan tabelltemperaturer.</div>
      </div>
    </div>

    <h2 style="font-size:1.05rem;margin-top:1rem">3. Tryck, dimensioner och tillägg</h2>
    <div class="grid">
      <div>
        <label for="dp">DP – Beräkningstryck (bar)</label>
        <input id="dp" type="number" />
      </div>
      <div>
        <label for="d">D – Ytterdiameter Dy (mm)</label>
        <input id="d" type="number" />
      </div>
      <div>
        <label for="z">z – Svetsfaktor</label>
        <input id="z" type="number" value="1.0" />
      </div>
      <div>
        <label for="a">a – Minustolerans (mm)</label>
        <input id="a" type="number" value="0" />
      </div>
      <div>
        <label for="c">c – Korrosionstillägg (mm)</label>
        <input id="c" type="number" value="0" />
      </div>
    </div>

    <div class="buttons">
      <button type="button" onclick="calculate()">Beräkna godstjocklek</button>
      <button type="button" class="secondary" onclick="window.print()">Exportera till PDF</button>
    </div>

    <div id="result" class="result"></div>
  </div>

  <footer>skapad av JL</footer>

  <script>
    // Tabell 4.16 – beräkningsfaktor f0
    const f0Table = {
      kompressor: { A:0.50, B:0.50, C:0.50, D:0.50, T:0.50 },
      utanSkydd: { A:0.60, B:0.50, C:0.50, D:0.40, T:0.30 },
      rorbrygga: { A:0.60, B:0.50, C:0.50, D:0.40, T:0.30 },
      tunnel:    { A:0.60, B:0.60, C:0.50, D:0.40, T:0.30 },
      linjeventil:{A:0.60, B:0.60, C:0.50, D:0.40, T:0.30 },
      skyddsror: { A:0.72, B:0.60, C:0.50, D:0.40, T:0.30 },
      enskildVag:{ A:0.72, B:0.60, C:0.50, D:0.40, T:0.30 },
      annan:     { A:0.72, B:0.60, C:0.50, D:0.40, T:0.30 }
    };

    function getF0(location, zone) {
      const row = f0Table[location];
      if (!row) return NaN;
      const val = row[zone];
      return (val !== undefined) ? val : NaN;
    }

    function updateF0Field() {
      const loc = document.getElementById('location').value;
      const zone = document.getElementById('zone').value;
      const f0 = getF0(loc, zone);
      const f0Input = document.getElementById('f0');
      if (!isNaN(f0)) {
        f0Input.value = f0.toFixed(2);
      } else {
        f0Input.value = "";
      }
    }

    // Materialdata: R_t0,5
    const materialData = {
      L245: { temps:[20,60], values:[245,245] },
      L290: { temps:[20,60], values:[290,290] },
      L360: { temps:[20,60], values:[360,360] },
      L415: { temps:[20,60], values:[415,415] },
      L450: { temps:[20,60], values:[450,450] },
      L485: { temps:[20,60], values:[485,485] },
      L555: { temps:[20,60], values:[555,555] },
      SA333G6:{ temps:[20,50,100], values:[220,217,206] }
    };

    function interpolateRt(materialKey, T) {
      const data = materialData[materialKey];
      if (!data) return null;
      const temps = data.temps;
      const vals = data.values;

      if (T <= temps[0]) {
        return { Rt: vals[0], note: `Temperatur under tabellområde – värdet vid ${temps[0]} °C används.` };
      }
      if (T >= temps[temps.length-1]) {
        return { Rt: vals[vals.length-1], note: `Temperatur över tabellområde – värdet vid ${temps[temps.length-1]} °C används.` };
      }

      for (let i = 0; i < temps.length - 1; i++) {
        const T1 = temps[i];
        const T2 = temps[i+1];
        if (T >= T1 && T <= T2) {
          const V1 = vals[i];
          const V2 = vals[i+1];
          const frac = (T - T1) / (T2 - T1);
          const Rt = V1 + frac * (V2 - V1);
          const note = `Linjär interpolering mellan ${T1} °C (${V1} N/mm²) och ${T2} °C (${V2} N/mm²).`;
          return { Rt, note };
        }
      }
      return null;
    }

    // NGSA tabell 4.17 – minsta nominella godstjocklek
    const minTnomTable = [
      { Dy: 60.3, t: 3.2 },
      { Dy: 76.1, t: 3.2 },
      { Dy: 88.9, t: 3.2 },
      { Dy:114.3, t: 3.2 },
      { Dy:168.3, t: 4.5 },
      { Dy:219.1, t: 4.5 },
      { Dy:273.0, t: 5.0 },
      { Dy:323.9, t: 5.2 },
      { Dy:355.6, t: 5.6 },
      { Dy:406.4, t: 6.3 },
      { Dy:508.0, t: 6.3 },
      { Dy:609.4, t: 6.3 }
    ];

    function getRecommendedTnom(Dy) {
      for (let i = 0; i < minTnomTable.length; i++) {
        if (Dy <= minTnomTable[i].Dy + 0.0001) {
          return { t: minTnomTable[i].t, rule: `Tabell 4.17, Dy ≤ ${minTnomTable[i].Dy} mm` };
        }
      }
      return { t: Dy * 0.01, rule: "Tabell 4.17, Dy > 609,4 mm (1 % av Dy)" };
    }

    function round(value, decimals) {
      const p = Math.pow(10, decimals);
      return Math.round(value * p) / p;
    }

    function calculate() {
      const dp   = parseFloat(document.getElementById('dp').value);
      const d    = parseFloat(document.getElementById('d').value);
      const z    = parseFloat(document.getElementById('z').value);
      const a    = parseFloat(document.getElementById('a').value) || 0;
      const c    = parseFloat(document.getElementById('c').value) || 0;
      const matKey = document.getElementById('material').value;
      const temp   = parseFloat(document.getElementById('temp').value);
      const loc  = document.getElementById('location').value;
      const zone = document.getElementById('zone').value;

      const resultDiv = document.getElementById('result');

      const f0 = getF0(loc, zone);

      if (isNaN(dp) || isNaN(d) || isNaN(z) || isNaN(f0) || isNaN(temp)) {
        resultDiv.innerHTML = "<span style='color:#c00'>Fyll i alla värden (tryck, diameter, svetsfaktor, temperatur) och kontrollera förläggning/zon.</span>";
        return;
      }

      const interp = interpolateRt(matKey, temp);
      if (!interp) {
        resultDiv.innerHTML = "<span style='color:#c00'>Kunde inte hitta materialdata för valt material.</span>";
        return;
      }
      const Rt = interp.Rt;
      const note = interp.note;

      const Tmin = (dp * d) / (20 * f0 * Rt * z);
      const Tnom = Tmin + a + c;

      const rec = getRecommendedTnom(d);
      const recT = rec.t;
      const recRule = rec.rule;

      const isTooThin = Tnom + 1e-6 < recT;

      let recHtml = `
        <div class="small">
          Rekommenderad minsta T<sub>nom</sub> enligt NGSA tabell 4.17 för Dy = ${round(d,1)} mm:<br/>
          T<sub>nom,rekommenderad</sub> ≈ ${round(recT,2)} mm (${recRule}).
        </div>
      `;

      let warnHtml = "";
      if (isTooThin) {
        warnHtml = `
          <div class="warning">
            Varning: Beräknad T<sub>nom</sub> = ${round(Tnom,2)} mm är tunnare än
            rekommenderad minsta T<sub>nom</sub> = ${round(recT,2)} mm enligt NGSA tabell 4.17.
            Öka godstjockleken eller välj större nominell tjocklek.
          </div>
        `;
      } else {
        warnHtml = `
          <div class="ok">
            Beräknad T<sub>nom</sub> uppfyller rekommenderad minsta tjocklek enligt NGSA tabell 4.17.
          </div>
        `;
      }

      resultDiv.innerHTML = `
        <div class="result-main">
          <span class="label">T<sub>min</sub>:</span>
          <span class="value"> ${round(Tmin, 2)} mm</span><br/>
          <span class="label">T<sub>nom</sub>:</span>
          <span class="value"> ${round(Tnom, 2)} mm</span>
          <span class="small">(inkl. a = ${round(a,2)} mm, c = ${round(c,2)} mm)</span>
        </div>
        ${recHtml}
        ${warnHtml}
        <br/>
        <span class="small">
          Vald zon/förläggning ger f₀ = ${round(f0,2)}.<br/>
          Material: ${matKey}, R<sub>t0,5</sub> ≈ ${round(Rt,1)} N/mm² vid ${round(temp,1)} °C.<br/>
          ${note}
        </span>
      `;

      updateF0Field();
    }

    window.addEventListener('load', updateF0Field);
  </script>
</body>
</html>
